# Документ требований

## Введение

Данная спецификация определяет требования к проектированию унифицированной схемы базы данных, которая объединяет сервисы baselinker_to_wix и allegro_orders_backup в комплексную систему управления складом. Система обеспечит полное отслеживание инвентаря с полными аудиторскими следами, прозрачностью и контролем доступа на основе ролей для различных групп товаров.

Объединенная система будет обрабатывать:
- Поступление товаров из Таиланда (закупка → приемка → размещение)
- Внутренние перемещения (между ячейками и между складами)
- Продажи через маркетплейсы (автоматическая синхронизация заказов и списание)
- Возвраты (ручной ввод, инспекция, возврат в оборот/списание)
- Разделение доступа по группам товаров (разные пользователи работают с разными инвентарями)
- Полный аудит каждого изменения и источника триггера
- Хранение медиафайлов для изображений товаров и вложений документов

## Требования

### Требование 1: Основное управление инвентарем

**Пользовательская история:** Как менеджер склада, я хочу иметь единый источник истины для всех движений инвентаря, чтобы отслеживать полную историю каждого товара и его текущее местоположение.

#### Критерии приемки

1. КОГДА происходит любая операция с инвентарем ТО система ДОЛЖНА создать запись в таблице stock_movement
2. КОГДА создаются записи stock_movement ТО система ДОЛЖНА автоматически обновлять stock_balance через триггеры
3. КОГДА запрашивается текущий инвентарь ТО система ДОЛЖНА использовать stock_balance как основной источник
4. КОГДА отслеживается история товара ТО система ДОЛЖНА предоставлять полный след движений из stock_movement
5. ЕСЛИ товар требует отслеживания партий ТО lot_id ДОЛЖЕН быть обязательным во всех движениях
6. ЕСЛИ товар требует отслеживания серийных номеров ТО serial_number_id ДОЛЖЕН быть обязательным и количество ДОЛЖНО соответствовать количеству серийников

### Требование 2: Топология склада и управление местоположениями

**Пользовательская история:** Как оператор склада, я хочу организовать инвентарь по складам, зонам и ячейкам, чтобы эффективно управлять хранением и операциями комплектации.

#### Критерии приемки

1. КОГДА создается структура склада ТО система ДОЛЖНА поддерживать иерархию склад → зона → ячейка
2. КОГДА определяются зоны ТО система ДОЛЖНА категоризировать по функциям (приемка, хранение, комплектация, отгрузка, возвраты, брак)
3. КОГДА управляются ячейки ТО система ДОЛЖНА отслеживать ограничения вместимости (вес, объем)
4. КОГДА выполняются операции ТО система ДОЛЖНА проверять совместимость ячейки с требованиями товара
5. КОГДА организуется комплектация ТО система ДОЛЖНА идентифицировать ячейки для комплектации для эффективного выполнения заказов

### Требование 3: Управление товарами и группами товаров

**Пользовательская история:** Как менеджер каталога, я хочу организовать товары в группы со специфическими политиками обработки, чтобы обеспечить соблюдение бизнес-правил и контроль доступа.

#### Критерии приемки

1. КОГДА создаются товары ТО система ДОЛЖНА требовать назначения в item_group
2. КОГДА определяются группы товаров ТО система ДОЛЖНА поддерживать настраиваемые политики обработки (правила смешивания партий, требования отслеживания)
3. КОГДА управляются товары ТО система ДОЛЖНА обеспечивать отслеживание партий/серийных номеров на основе конфигурации товара
4. КОГДА хранятся товары ТО система ДОЛЖНА проверять политики обработки перед разрешением движений
5. КОГДА осуществляется доступ к товарам ТО система ДОЛЖНА фильтровать по разрешениям пользователя на группы товаров

### Требование 4: Приемка и размещение товаров

**Пользовательская история:** Как приемщик, я хочу обрабатывать файлы прихода товаров из Таиланда, чтобы точно записывать что было получено и размещать товары на складе.

#### Критерии приемки

1. КОГДА загружается файл прихода ТО система ДОЛЖНА сохранить оригинальный файл в неизменном виде
2. КОГДА обрабатывается файл прихода ТО система ДОЛЖНА создавать движения напрямую из NULL в storage_bin (приемка + размещение одной операцией)
3. КОГДА завершается приемка ТО система ДОЛЖНА генерировать аудиторские логи и доменные события
4. КОГДА принимаются товары с отслеживанием партий ТО система ДОЛЖНА требовать информацию о партии из файла
5. КОГДА принимаются товары с отслеживанием серийных номеров ТО система ДОЛЖНА требовать индивидуальные серийные номера из файла

### Требование 5: Заказы на продажу и интеграция с маркетплейсами

**Пользовательская история:** Как менеджер электронной коммерции, я хочу автоматически обрабатывать заказы с маркетплейсов и резервировать инвентарь, чтобы эффективно выполнять заказы без перепродажи.

#### Критерии приемки

1. КОГДА поступают заказы с маркетплейсов ТО система ДОЛЖНА создавать sales_order с отслеживанием внешнего канала
2. КОГДА резервируется инвентарь ТО система ДОЛЖНА резервировать запасы и создавать записи inventory_reservation
3. КОГДА отгружаются заказы ТО система ДОЛЖНА создавать движения напрямую из storage_bin в NULL (упрощенное списание)
4. КОГДА обрабатываются заказы ТО система ДОЛЖНА обновлять статус заказа и количества
5. КОГДА завершается отгрузка ТО система ДОЛЖНА генерировать доменные события для внешних систем
6. КОГДА заказ не выполняется ТО система ДОЛЖНА освобождать резервы и восстанавливать доступные запасы
7. КОГДА списываются товары ТО система ДОЛЖНА создавать детальную аналитику продаж с информацией о маркетплейсе, цене, марже, дате продажи для анализа и планирования закупок

### Требование 6: Ручное списание и корректировки

**Пользовательская история:** Как оператор склада, я хочу иметь возможность вручную списывать товары (брак, потери, корректировки) с полным аудитом, чтобы поддерживать точность остатков.

#### Критерии приемки

1. КОГДА выполняется ручное списание ТО система ДОЛЖНА создавать движение из storage_bin в NULL с причиной списания
2. КОГДА списываются товары ТО система ДОЛЖНА требовать обязательное указание причины (брак, потери, корректировка, инвентаризация)
3. КОГДА выполняется списание ТО система ДОЛЖНА записывать пользователя, время и детали операции в аудит
4. КОГДА списание превышает лимиты ТО система ДОЛЖНА требовать дополнительные разрешения
5. КОГДА завершается списание ТО система ДОЛЖНА генерировать доменные события и уведомления

### Требование 7: Обработка возвратов и инспекция

**Пользовательская история:** Как обработчик возвратов, я хочу принимать и инспектировать возвращенные товары, чтобы решать возвращать ли их в запасы или списывать.

#### Критерии приемки

1. КОГДА принимаются возвраты ТО система ДОЛЖНА создавать return_order связанный с оригинальным sales_order
2. КОГДА поступают товары ТО система ДОЛЖНА создавать движения из NULL в storage_bin (упрощенная приемка возврата)
3. КОГДА инспектируются товары ТО система ДОЛЖНА записывать решения инспекции (return_to_stock, scrap, repair)
4. КОГДА товары признаются браком ТО система ДОЛЖНА создавать движения из storage_bin в NULL с причиной "возврат-брак"
5. КОГДА завершается инспекция ТО система ДОЛЖНА генерировать события и обновлять аналитику возвратов

### Требование 8: Внутренние перемещения

**Пользовательская история:** Как оператор склада, я хочу перемещать инвентарь между местоположениями, чтобы оптимизировать хранение и выполнять заказы.

#### Критерии приемки

1. КОГДА перемещается товар ТО система ДОЛЖНА создавать одно движение из source_bin в destination_bin
2. КОГДА завершается перемещение ТО система ДОЛЖНА генерировать аудиторские логи и доменные события
3. КОГДА перемещение не удается ТО система ДОЛЖНА предоставлять возможности отката

### Требование 9: Аналитика продаж и планирование закупок

**Пользовательская история:** Как менеджер по закупкам, я хочу получать детальную аналитику продаж по маркетплейсам, чтобы планировать закупки и анализировать эффективность продаж.

#### Критерии приемки

1. КОГДА происходит продажа ТО система ДОЛЖНА записывать детальную аналитику: SKU, количество, цену продажи, себестоимость, маржу, маркетплейс, дату
2. КОГДА анализируются продажи ТО система ДОЛЖНА предоставлять отчеты по оборачиваемости товаров, популярности SKU, рентабельности по маркетплейсам
3. КОГДА планируются закупки ТО система ДОЛЖНА рекомендовать товары для заказа на основе скорости продаж, остатков и сезонности
4. КОГДА анализируется эффективность ТО система ДОЛЖНА показывать ABC-анализ товаров, медленно движущиеся позиции, топ продаж
5. КОГДА строятся прогнозы ТО система ДОЛЖНА учитывать исторические данные продаж, тренды, сезонность для расчета потребности в закупках
6. КОГДА отслеживается прибыльность ТО система ДОЛЖНА рассчитывать маржинальность по товарам, группам, маркетплейсам с учетом всех затрат

### Требование 10: Управление медиа и документами

**Пользовательская история:** Как офицер по соответствию, я хочу чтобы все изображения товаров и операционные документы хранились неизменно, чтобы поддерживать полные аудиторские следы и соответствие регулятивным требованиям.

#### Критерии приемки

1. КОГДА загружаются файлы ТО система ДОЛЖНА вычислять и хранить SHA-256 хэш содержимого
2. КОГДА хранятся медиа ТО система ДОЛЖНА поддерживать как базу данных, так и S3-совместимые бэкенды хранения
3. КОГДА файлы помечены как неизменяемые ТО система ДОЛЖНА предотвращать модификацию содержимого
4. КОГДА установлено WORM удержание ТО система ДОЛЖНА предотвращать удаление до истечения срока удержания
5. КОГДА осуществляется доступ к файлам ТО система ДОЛЖНА логировать все попытки доступа с пользователем и временной меткой
6. КОГДА генерируются производные ТО система ДОЛЖНА автоматически создавать миниатюры и превью
7. КОГДА прикрепляются к операциям ТО система ДОЛЖНА связывать файлы с конкретными движениями и документами

### Требование 11: Управление изображениями товаров

**Пользовательская история:** Как менеджер каталога, я хочу чтобы каждый товар имел связанные изображения с автоматической генерацией миниатюр, чтобы поддерживать визуальные каталоги товаров.

#### Критерии приемки

1. КОГДА добавляются товары ТО система ДОЛЖНА требовать минимум одно изображение для публикации в каталоге
2. КОГДА загружаются изображения ТО система ДОЛЖНА автоматически генерировать миниатюры и превью
3. КОГДА управляются изображения ТО система ДОЛЖНА поддерживать назначение основного изображения и порядок отображения
4. КОГДА хранятся изображения ТО система ДОЛЖНА поддерживать оригинальные файлы и сгенерированные производные
5. КОГДА осуществляется доступ к изображениям ТО система ДОЛЖНА предоставлять подходящее разрешение в зависимости от случая использования

### Требование 12: Система прикрепления документов

**Пользовательская история:** Как операционный менеджер, я хочу чтобы все бизнес-документы были прикреплены к связанным операциям, чтобы поддерживать полную документацию для аудитов и устранения неполадок.

#### Критерии приемки

1. КОГДА обрабатываются заказы на закупку ТО система ДОЛЖНА хранить счета поставщиков и сканы GRN
2. КОГДА обрабатываются заказы с маркетплейсов ТО система ДОЛЖНА хранить полезные нагрузки заказов и транспортные этикетки
3. КОГДА выполняются трансферы ТО система ДОЛЖНА хранить манифесты трансферов и квитанции
4. КОГДА обрабатываются возвраты ТО система ДОЛЖНА хранить фотографии возвратов и отчеты инспекции
5. КОГДА выполняются движения ТО система ДОЛЖНА позволять прикрепление фото-доказательств и документации
6. КОГДА хранятся документы ТО система ДОЛЖНА поддерживать оригинальный формат и предотвращать модификацию

### Требование 13: Аудиторский след и логирование событий

**Пользовательская история:** Как системный администратор, я хочу полные аудиторские следы всех изменений и их источников, чтобы отслеживать ответственность и устранять проблемы.

#### Критерии приемки

1. КОГДА изменяются любые данные ТО система ДОЛЖНА записывать состояния до/после в audit_log
2. КОГДА происходят операции ТО система ДОЛЖНА захватывать actor_user_id и trigger_source
3. КОГДА происходят бизнес-события ТО система ДОЛЖНА создавать записи domain_event
4. КОГДА коррелируются операции ТО система ДОЛЖНА использовать correlation_identifier для отслеживания запросов
5. КОГДА запрашивается история ТО система ДОЛЖНА предоставлять полную временную линию изменений с контекстом
6. КОГДА операции охватывают несколько записей ТО система ДОЛЖНА группировать их с transaction_group

### Требование 14: Контроль доступа на основе ролей

**Пользовательская история:** Как администратор безопасности, я хочу контролировать доступ к различным складам и группам товаров, чтобы пользователи видели и изменяли только тот инвентарь, с которым им разрешено работать.

#### Критерии приемки

1. КОГДА назначаются разрешения ТО система ДОЛЖНА поддерживать гранты на уровне склада и группы товаров
2. КОГДА пользователи получают доступ к данным ТО система ДОЛЖНА фильтровать результаты на основе записей warehouse_access_grant
3. КОГДА выполняются операции ТО система ДОЛЖНА проверять разрешения пользователя перед разрешением изменений
4. КОГДА просматриваются отчеты ТО система ДОЛЖНА применять контроль доступа ко всем запросам данных
5. КОГДА управляются пользователи ТО система ДОЛЖНА поддерживать назначение разрешений на основе ролей
6. КОГДА осуществляется доступ к API ТО система ДОЛЖНА обеспечивать тот же контроль доступа, что и операции UI

### Требование 15: Целостность данных и бизнес-правила

**Пользовательская история:** Как бизнес-аналитик, я хочу чтобы система автоматически обеспечивала соблюдение бизнес-правил, чтобы данные оставались согласованными, а операции следовали политикам компании.

#### Критерии приемки

1. КОГДА смешивание партий запрещено ТО система ДОЛЖНА предотвращать несколько партий в одной ячейке
2. КОГДА включено отслеживание серийных номеров ТО система ДОЛЖНА обеспечивать соответствие один к одному серийный номер к количеству
3. КОГДА отгружаются заказы ТО система ДОЛЖНА проверять что выделенные количества соответствуют заказанным количествам
4. КОГДА выполняются операции ТО система ДОЛЖНА проверять достаточность инвентаря перед разрешением движений
5. КОГДА обновляются статусы ТО система ДОЛЖНА обеспечивать валидные переходы состояний

### Требование 16: Производительность и масштабируемость

**Пользовательская история:** Как пользователь системы, я хочу быстрое время отклика для запросов инвентаря и операций, чтобы работать эффективно без задержек.

#### Критерии приемки

1. КОГДА запрашиваются текущие запасы ТО система ДОЛЖНА отвечать в течение 500мс для типичных размеров склада
2. КОГДА обрабатываются движения ТО система ДОЛЖНА обрабатывать параллельные операции без конфликтов
3. КОГДА генерируются отчеты ТО система ДОЛЖНА использовать подходящие индексы и материализованные представления
4. КОГДА хранятся большие объемы ТО система ДОЛЖНА поддерживать партиционирование истории движений
5. КОГДА осуществляется доступ к часто используемым данным ТО система ДОЛЖНА поддерживать оптимизированные индексы
6. КОГДА система растет ТО система ДОЛЖНА масштабироваться горизонтально без крупной реструктуризации

### Требование 17: Интеграция и внешние системы

**Пользовательская история:** Как разработчик интеграции, я хочу стандартизированные API и потоки событий, чтобы подключать внешние системы и поддерживать синхронизацию данных.

#### Критерии приемки

1. КОГДА внешние системы создают заказы ТО система ДОЛЖНА отслеживать external_sales_channel и external_order_identifier
2. КОГДА операции завершаются ТО система ДОЛЖНА публиковать доменные события для потребления нижестоящими системами
3. КОГДА вызываются API ТО система ДОЛЖНА предоставлять согласованные форматы запрос/ответ
4. КОГДА интегрируются маркетплейсы ТО система ДОЛЖНА обрабатывать различные форматы заказов и требования
5. КОГДА синхронизируются данные ТО система ДОЛЖНА предоставлять идемпотентные операции и разрешение конфликтов
6. КОГДА происходят ошибки ТО система ДОЛЖНА предоставлять детальную информацию об ошибках для устранения неполадок