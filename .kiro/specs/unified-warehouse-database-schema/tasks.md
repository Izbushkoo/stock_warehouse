# План реализации

- [ ] 1. Создание базовой структуры базы данных
  - Создать основные таблицы для складской топологии (warehouse, zone, bin_location)
  - Создать таблицы для товаров и групп (item_group, item, lot, serial_number)
  - Добавить базовые индексы и ограничения целостности
  - _Требования: 1.1, 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 2. Реализация ядра системы движений
  - [ ] 2.1 Создать таблицу stock_movement как источник истины
    - Определить структуру таблицы с полями для источника/назначения, количества, причины
    - Добавить поля для аудита (actor_user_id, trigger_source, correlation_identifier)
    - Создать индексы для производительности запросов
    - _Требования: 1.1, 1.4_

  - [ ] 2.2 Создать таблицу stock_balance как материализованное представление
    - Определить структуру с уникальными ключами по складу/ячейке/товару/лоту/серийнику
    - Добавить поля quantity_on_hand и quantity_reserved
    - Создать уникальные индексы для предотвращения дублирования
    - _Требования: 1.2, 1.3_

  - [ ] 2.3 Реализовать триггеры для автоматического обновления балансов
    - Создать триггер AFTER INSERT на stock_movement для обновления stock_balance
    - Обеспечить атомарность операций обновления балансов
    - Добавить валидацию бизнес-правил в триггерах
    - _Требования: 1.2, 15.1, 15.4, 15.5_

- [ ] 3. Создание системы заказов и резервирования
  - [ ] 3.1 Реализовать таблицы заказов на продажу
    - Создать sales_order с поддержкой внешних каналов (маркетплейсы)
    - Создать sales_order_line для позиций заказов
    - Добавить поля для отслеживания external_sales_channel и external_order_identifier
    - _Требования: 5.1, 5.4, 17.1_

  - [ ] 3.2 Реализовать систему резервирования инвентаря
    - Создать таблицу inventory_reservation для резервов под заказы
    - Связать резервы с конкретными ячейками и лотами
    - Реализовать логику освобождения резервов при отмене заказов
    - _Требования: 5.2, 5.6_

  - [ ] 3.3 Создать таблицы для возвратов
    - Создать return_order и return_order_line
    - Добавить поля для решений инспекции (return_to_stock, scrap, repair)
    - Связать возвраты с оригинальными заказами на продажу
    - _Требования: 7.1, 7.3, 7.5_

- [ ] 4. Реализация системы медиа и документов
  - [ ] 4.1 Создать базовые таблицы для медиафайлов
    - Создать media_asset для неизменяемых оригиналов с SHA-256 хэшами
    - Создать media_derivative для производных файлов (превью, миниатюры)
    - Добавить поддержку как database, так и S3 storage backends
    - _Требования: 10.1, 10.2, 10.3, 10.4_

  - [ ] 4.2 Реализовать систему изображений товаров
    - Создать item_image для связи товаров с изображениями
    - Добавить поддержку основного изображения и порядка отображения
    - Реализовать автоматическую генерацию производных изображений
    - _Требования: 11.1, 11.2, 11.3, 11.4, 11.5_

  - [ ] 4.3 Создать систему прикрепления документов
    - Создать document_file для документов операций (накладные, этикетки)
    - Создать movement_attachment для файлов к конкретным движениям
    - Обеспечить неизменяемость документов после загрузки
    - _Требования: 12.1, 12.2, 12.3, 12.4, 12.5, 12.6_

- [ ] 5. Реализация аналитики и отчетности
  - [ ] 5.1 Создать систему аналитики продаж
    - Создать sales_analytics для детальной аналитики каждой продажи
    - Добавить поля для цены, себестоимости, маржи, маркетплейса
    - Включить временные метрики (сезон, день недели) для анализа трендов
    - _Требования: 9.1, 9.2, 9.6_

  - [ ] 5.2 Реализовать систему рекомендаций по закупкам
    - Создать purchase_recommendation для автоматических рекомендаций
    - Добавить расчет скорости продаж, оборачиваемости, сезонности
    - Реализовать алгоритм приоритизации товаров для заказа
    - _Требования: 9.3, 9.4, 9.5_

  - [ ] 5.3 Создать триггеры для автоматического заполнения аналитики
    - Создать триггер на stock_movement для записи аналитики продаж
    - Реализовать периодическое обновление рекомендаций по закупкам
    - Добавить расчет метрик оборачиваемости и ABC-анализа
    - _Требования: 5.7, 9.1, 9.2_

- [ ] 6. Реализация системы аудита и безопасности
  - [ ] 6.1 Создать систему пользователей и прав доступа
    - Создать app_user для пользователей системы
    - Создать warehouse_access_grant для гранулярного контроля доступа
    - Реализовать проверку прав на уровне склада и группы товаров
    - _Требования: 14.1, 14.2, 14.3, 14.4, 14.5, 14.6_

  - [ ] 6.2 Реализовать систему аудиторского логирования
    - Создать audit_log для записи всех изменений с состояниями до/после
    - Создать domain_event для бизнес-событий
    - Добавить триггеры для автоматического логирования изменений
    - _Требования: 13.1, 13.2, 13.3, 13.4, 13.5, 13.6_

  - [ ] 6.3 Реализовать систему корреляции и трассировки
    - Добавить поддержку correlation_identifier во все операции
    - Реализовать transaction_group для группировки связанных операций
    - Создать механизм отслеживания источника операций (trigger_source)
    - _Требования: 13.4, 13.6_

- [ ] 7. Создание основных бизнес-операций
  - [ ] 7.1 Реализовать операцию приемки товаров
    - Создать функцию для обработки файлов прихода
    - Реализовать создание движений напрямую из NULL в storage_bin
    - Добавить валидацию лотов и серийных номеров при приемке
    - _Требования: 4.1, 4.2, 4.3, 4.4, 4.5_

  - [ ] 7.2 Реализовать операции продаж и списания
    - Создать функцию для обработки заказов с маркетплейсов
    - Реализовать резервирование и списание товаров
    - Добавить автоматическое создание аналитики продаж
    - _Требования: 5.1, 5.2, 5.3, 5.4, 5.5, 5.7_

  - [ ] 7.3 Реализовать операции возвратов
    - Создать функцию для приемки возвратов
    - Реализовать инспекцию и принятие решений по возвратам
    - Добавить списание брака и возврат в оборот
    - _Требования: 7.1, 7.2, 7.3, 7.4, 7.5_

  - [ ] 7.4 Реализовать ручные операции списания
    - Создать функцию для ручного списания с указанием причины
    - Добавить валидацию прав пользователя на списание
    - Реализовать лимиты на суммы списания и требование разрешений
    - _Требования: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 8. Реализация внутренних перемещений
  - Создать функцию для перемещения товаров между ячейками
  - Добавить валидацию совместимости ячеек с товарами
  - Реализовать проверку вместимости ячеек при перемещении
  - _Требования: 8.1, 8.2, 8.3_

- [ ] 9. Создание индексов и оптимизация производительности
  - [ ] 9.1 Создать основные индексы для производительности
    - Добавить индексы на stock_movement (occurred_at, item_id, warehouse_id)
    - Создать индексы на stock_balance для быстрых запросов остатков
    - Добавить индексы для аналитических запросов
    - _Требования: 16.1, 16.3, 16.5_

  - [ ] 9.2 Реализовать партиционирование для больших таблиц
    - Настроить партиционирование stock_movement по месяцам
    - Добавить партиционирование audit_log по времени
    - Создать стратегию архивирования старых данных
    - _Требования: 16.4, 16.6_

- [ ] 10. Создание API функций и хранимых процедур
  - [ ] 10.1 Создать функции для основных операций
    - Реализовать create_stock_movement() с валидацией
    - Создать upload_media_asset() с автогенерацией производных
    - Добавить record_sale_analytics() для аналитики
    - _Требования: 1.1, 10.6, 9.1_

  - [ ] 10.2 Реализовать функции для отчетности
    - Создать функции для расчета оборачиваемости товаров
    - Добавить функции для ABC-анализа и анализа медленно движущихся товаров
    - Реализовать функции для прогнозирования потребности в закупках
    - _Требования: 9.2, 9.4, 9.5_

- [ ] 11. Реализация валидации и бизнес-правил
  - Создать триггеры для валидации обязательности лотов/серийников
  - Добавить проверки достаточности остатков перед списанием
  - Реализовать валидацию политик групп товаров (запрет смешивания лотов)
  - _Требования: 15.1, 15.2, 15.4, 15.5_

- [ ] 12. Создание системы миграций и начальных данных
  - [ ] 12.1 Создать миграции для всех таблиц
    - Написать Alembic миграции для создания всех таблиц
    - Добавить миграции для индексов и ограничений
    - Создать миграции для триггеров и функций
    - _Требования: все_

  - [ ] 12.2 Подготовить начальные данные
    - Создать базовые склады и зоны
    - Добавить группы товаров по умолчанию
    - Создать административного пользователя и базовые права
    - _Требования: 2.1, 2.2, 3.1, 14.1_

- [ ] 13. Тестирование и валидация системы
  - [ ] 13.1 Создать unit тесты для основных функций
    - Написать тесты для функций создания движений
    - Добавить тесты для валидации бизнес-правил
    - Создать тесты для расчета аналитики
    - _Требования: все основные функции_

  - [ ] 13.2 Создать интеграционные тесты
    - Написать тесты для полных сценариев операций
    - Добавить тесты для проверки целостности данных
    - Создать тесты для производительности при больших объемах данных
    - _Требования: 16.1, 16.2_

- [ ] 14. Документация и финализация
  - Создать документацию по API функциям
  - Написать руководство по эксплуатации системы
  - Подготовить схемы миграции с существующих систем
  - _Требования: все_