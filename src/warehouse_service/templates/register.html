{% extends "base.html" %}
{% block title %}–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è - Unified Warehouse{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <div>
            <div class="mx-auto h-12 w-12 flex items-center justify-center rounded-full bg-primary-100">
                <span class="text-2xl">üÜï</span>
            </div>
            <h2 class="mt-6 text-center text-3xl font-extrabold text-gray-900">
                –°–æ–∑–¥–∞–π—Ç–µ —É—á—ë—Ç–Ω—É—é –∑–∞–ø–∏—Å—å
            </h2>
            <p class="mt-2 text-center text-sm text-gray-600">
                –ü–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥—ë—Ç–µ –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.
            </p>
        </div>

        <form class="mt-8 space-y-6" id="registerForm">
            <div class="rounded-md shadow-sm -space-y-px">
                <div>
                    <label for="reg_email" class="sr-only">Email</label>
                    <input id="reg_email" name="email" type="email" required autofocus
                           class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none focus:ring-primary-500 focus:border-primary-500 focus:z-10 sm:text-sm"
                           placeholder="Email address">
                </div>
                <div>
                    <label for="reg_display_name" class="sr-only">–ò–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</label>
                    <input id="reg_display_name" name="display_name" type="text" required
                           class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary-500 focus:border-primary-500 focus:z-10 sm:text-sm"
                           placeholder="–ò–º—è –∏ —Ñ–∞–º–∏–ª–∏—è">
                </div>
                <div>
                    <label for="reg_password" class="sr-only">–ü–∞—Ä–æ–ª—å</label>
                    <input id="reg_password" name="password" type="password" minlength="6" required
                           class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none focus:ring-primary-500 focus:border-primary-500 focus:z-10 sm:text-sm"
                           placeholder="–ü–∞—Ä–æ–ª—å">
                </div>
                <div>
                    <label for="reg_password_confirm" class="sr-only">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è</label>
                    <input id="reg_password_confirm" name="password_confirm" type="password" minlength="6" required
                           class="appearance-none rounded-none relative block w-full px-3 py-2 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none focus:ring-primary-500 focus:border-primary-500 focus:z-10 sm:text-sm"
                           placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
                </div>
            </div>

            <div>
                <button type="submit" id="registerBtn"
                        class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 disabled:opacity-50 disabled:cursor-not-allowed">
                    <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                        <svg class="h-5 w-5 text-primary-500 group-hover:text-primary-400" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11V5a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2z" clip-rule="evenodd" />
                        </svg>
                    </span>
                    <span id="registerText">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</span>
                </button>
            </div>

            <div class="text-center">
                <p class="text-sm text-gray-600">
                    –£–∂–µ –µ—Å—Ç—å —É—á—ë—Ç–Ω–∞—è –∑–∞–ø–∏—Å—å? <a href="/" class="font-medium text-primary-600 hover:text-primary-500">–í–æ–π—Ç–∏</a>
                </p>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const registerForm = document.getElementById('registerForm');
const registerBtn = document.getElementById('registerBtn');
const registerText = document.getElementById('registerText');

registerForm.addEventListener('submit', async (event) => {
    event.preventDefault();

    const email = document.getElementById('reg_email').value.trim();
    const displayName = document.getElementById('reg_display_name').value.trim();
    const password = document.getElementById('reg_password').value;
    const passwordConfirm = document.getElementById('reg_password_confirm').value;

    if (password !== passwordConfirm) {
        showError('–ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç');
        return;
    }

    registerBtn.disabled = true;
    registerText.textContent = '–°–æ–∑–¥–∞–Ω–∏–µ...';

    try {
        const response = await fetch('/auth/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, display_name: displayName, password })
        });

        const result = await response.json();

        if (!response.ok) {
            showError(result.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            return;
        }

        showSuccess('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω. –í—ã–ø–æ–ª–Ω—è–µ–º –≤—Ö–æ–¥...');

        const loginResponse = await fetch('/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ email, password })
        });

        const loginResult = await loginResponse.json();
        if (!loginResponse.ok) {
            showError('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Ö–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤—Ä—É—á–Ω—É—é.');
            setTimeout(() => {
                window.location.href = '/?message=' + encodeURIComponent('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω, –≤–æ–π–¥–∏—Ç–µ —Å –Ω–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏') + '&status=success';
            }, 1500);
            return;
        }

        localStorage.setItem('access_token', loginResult.access_token);
        localStorage.setItem('user_id', loginResult.user_id);

        setTimeout(() => {
            window.location.href = '/admin';
        }, 800);
    } catch (error) {
        console.error(error);
        showError('–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É –ø–æ–∑–∂–µ.');
    } finally {
        registerBtn.disabled = false;
        registerText.textContent = '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
    }
});
</script>
{% endblock %}
